<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<style>
.login-btn, #profileBtn {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1000;
  background: none;
  border: 2px solid #fff;
  color: #fff;
  border-radius: 25px;
  padding: 10px 24px;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.login-btn i, #profileBtn i {
  font-size: 1.3rem;
}
:root {
    --bg-color: #212529;
    --card-bg: #2c3034;
    --text-color: #ffffff;
    --border-color: #495057;
    --header-bg: #1a1d20;
    --header-text: #ffffff;
    --hover-bg: #0d6efd;
    --table-header-bg: #343a40;
    --table-header-text: #ffffff;
    --table-row-hover: #343a40;
    --info-window-bg: #2d2d2d;
    --info-window-text: #ffffff;
    --info-window-link: #66b3ff;
    --table-bg: #212529;
    --form-bg: #212529;
    --form-text: #ffffff;
    --alert-bg: #343a40;
    --alert-text: #ffffff;
    --map-heading-bg: #343a40;
    --map-heading-text: #ffffff;
    --table-row-bg: #2c3034;
    --table-row-alt-bg: #343a40;
    --table-border: #495057;
}
body {
    background-color: #212529 !important;
    color: #fff !important;
}
.card, .table, .table thead th, .table tbody tr, .table tbody td {
    background-color: #2c3034 !important;
    color: #fff !important;
    border-color: #495057 !important;
}
.table thead th {
    background-color: #343a40 !important;
    color: #fff !important;
}
.table tbody tr:nth-child(even) {
    background-color: #343a40 !important;
}
.table tbody td a {
    color: #66b3ff !important;
}

/* Auth Modal Light Theme Override */
#authModal .modal-content {
  background: #fff !important;
  color: #222 !important;
}
#authModal .form-control {
  background: #fff !important;
  color: #222 !important;
  border: 1px solid #ccc !important;
}
#authModal .form-label {
  color: #222 !important;
}
#authModal .btn-primary,
#authModal .btn-success {
  background: #366092 !important;
  color: #fff !important;
  border: none !important;
}
#authModal .btn-primary:hover,
#authModal .btn-success:hover {
  background: #27496d !important;
}
#authModal .nav-link {
  color: #366092 !important;
}
#authModal .nav-link.active {
  color: #222 !important;
  background: #e9ecef !important;
  border-color: #dee2e6 #dee2e6 #fff !important;
}

/* Profile Modal Light Theme Override */
#profileModal .modal-content {
  background: var(--card-bg);
  color: var(--text-color);
}
#profileModal .form-control {
  background: var(--form-bg);
  color: var(--form-text);
  border: 1px solid var(--border-color);
}
#profileModal .form-label {
  color: var(--text-color);
}
#profileModal .btn-primary {
  background: var(--header-bg);
  color: var(--header-text);
  border: none;
}
#profileModal .btn-primary:hover {
  background: var(--hover-bg);
}

/* Settings Tab Styling */
#profileModal .nav-tabs {
  border-bottom: 1px solid var(--border-color);
}

#profileModal .nav-tabs .nav-link {
  color: var(--text-color);
  border: 1px solid transparent;
  border-radius: 0.375rem 0.375rem 0 0;
  padding: 0.75rem 1rem;
  font-weight: 500;
}

#profileModal .nav-tabs .nav-link:hover {
  border-color: var(--border-color) var(--border-color) var(--border-color);
  background-color: var(--table-row-hover);
}

#profileModal .nav-tabs .nav-link.active {
  color: var(--header-text);
  background-color: var(--header-bg);
  border-color: var(--border-color) var(--border-color) var(--header-bg);
}

#profileModal .card {
  border: 1px solid var(--border-color);
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

#profileModal .card-header {
  background-color: var(--header-bg);
  border-bottom: 1px solid var(--border-color);
  padding: 0.75rem 1rem;
  font-weight: 600;
}

#profileModal .card-header h6 {
  margin: 0;
  color: var(--header-text);
}

#profileModal .card-body {
  padding: 1rem;
}

#profileModal .form-text {
  color: var(--text-color) !important;
  font-size: 0.875rem;
}

#profileModal .btn-outline-info {
  color: var(--hover-bg);
  border-color: var(--hover-bg);
}

#profileModal .btn-outline-info:hover {
  color: var(--header-text);
  background-color: var(--hover-bg);
  border-color: var(--hover-bg);
}

#profileModal .btn-outline-danger {
  color: #dc3545;
  border-color: #dc3545;
}

#profileModal .btn-outline-danger:hover {
  color: var(--header-text);
  background-color: #dc3545;
  border-color: #dc3545;
}

#profileModal .btn-warning {
  background-color: #ffc107;
  border-color: #ffc107;
  color: #000;
}

#profileModal .btn-warning:hover {
  background-color: #ffca2c;
  border-color: #ffc720;
  color: #000;
}

        :root[data-theme="dark"] {
            --bg-color: #212529;
            --card-bg: #2c3034;
            --text-color: #ffffff;
            --border-color: #495057;
            --header-bg: #1a1d20;
            --header-text: #ffffff;
            --hover-bg: #0d6efd;
            --table-header-bg: #343a40;
            --table-header-text: #ffffff;
            --table-row-hover: #343a40;
            --info-window-bg: #2d2d2d;
            --info-window-text: #ffffff;
            --info-window-link: #66b3ff;
            --table-bg: #212529;
            --form-bg: #212529;
            --form-text: #ffffff;
            --alert-bg: #343a40;
            --alert-text: #ffffff;
            --map-heading-bg: #343a40;
            --map-heading-text: #ffffff;
            --table-row-bg: #2c3034;
            --table-row-alt-bg: #343a40;
            --table-border: #495057;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }

        .card-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            border-bottom: 1px solid var(--border-color);
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
            transition: background-color 0.3s ease;
        }

        .card-body {
            color: var(--text-color);
        }

        .form-control, .form-select {
            background-color: var(--form-bg);
            color: var(--form-text);
            border-color: var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--form-bg);
            color: var(--form-text);
            border-color: var(--hover-bg);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .btn-primary {
            background-color: var(--header-bg);
            border-color: var(--header-bg);
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease;
            color: var(--header-text);
        }

        .btn-primary:hover {
            background-color: var(--hover-bg);
            border-color: var(--hover-bg);
        }

        .btn-secondary {
            background-color: var(--table-header-bg);
            border-color: var(--table-header-bg);
            color: var(--header-text);
        }

        .btn-secondary:hover {
            background-color: var(--table-row-hover);
            border-color: var(--table-row-hover);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: var(--table-bg);
        }

        .table {
            margin-bottom: 0;
            border: 1px solid var(--border-color);
        }

        .table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: bold;
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .table tbody tr {
            background-color: var(--table-bg);
            color: var(--text-color);
        }

        .table tbody tr:nth-child(even) {
            background-color: var(--card-bg);
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            vertical-align: middle;
        }

        .table tbody td a {
            color: var(--info-window-link);
            text-decoration: none;
            font-weight: 500;
        }

        .table tbody td a:hover {
            text-decoration: underline;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }

        .results-section {
            display: none;
            margin-top: 2rem;
        }

        .alert {
            color: var(--alert-text);
            background-color: var(--alert-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            display: none;
        }

        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .theme-switcher .btn {
            background-color: var(--header-bg);
            color: var(--header-text);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .theme-switcher .btn:hover {
            background-color: var(--hover-bg);
        }

        .theme-switcher .dropdown-menu {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-radius: 10px;
            padding: 0.5rem;
        }

        .theme-switcher .dropdown-item {
            color: var(--text-color);
            border-radius: 5px;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s ease;
        }

        .theme-switcher .dropdown-item:hover {
            background-color: var(--table-row-hover);
        }

        .theme-switcher .dropdown-item.active {
            background-color: var(--header-bg);
            color: var(--header-text);
        }

        /* Select2 Theme Customization */
        .select2-container--default .select2-selection--single {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--text-color);
        }

        .select2-dropdown {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        .select2-container--default .select2-results__option {
            color: var(--text-color);
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--header-bg);
            color: var(--header-text);
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }
        
        .map-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .map-container {
            position: relative;
            height: 400px;
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .map-container h3 {
            color: var(--map-heading-text);
            margin-bottom: 15px;
        }
        
        .lead-marker {
            cursor: pointer;
        }
        
        .lead-info-window {
            max-width: 300px;
            background-color: var(--info-window-bg);
            color: var(--info-window-text);
            padding: 10px;
            border-radius: 8px;
        }
        
        .lead-info-window h5 {
            margin-bottom: 0.5rem;
            color: var(--info-window-text);
            font-weight: bold;
        }
        
        .lead-info-window p {
            margin-bottom: 0.25rem;
            color: var(--info-window-text);
        }

        .lead-info-window a {
            color: var(--info-window-link);
            text-decoration: none;
        }

        .lead-info-window a:hover {
            text-decoration: underline;
        }

        /* Update form text colors */
        .form-label {
            color: var(--text-color);
            font-weight: 500;
        }

        .form-text {
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Update map container text */
        #mapContainer h3 {
            color: var(--map-heading-text);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--form-bg);
            border: 1px solid var(--form-text);
            color: var(--form-text);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--table-header-bg);
        }

        .theme-toggle i {
            font-size: 1.2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .search-form {
            flex: 1;
            min-width: 300px;
        }

        .map-wrapper {
            flex: 2;
            min-width: 300px;
            height: 400px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-form, .map-wrapper {
                width: 100%;
            }
            
            .map-wrapper {
                height: 300px;
            }
        }

        /* Force dark mode styles for the search results section */
        :root[data-theme="dark"] .card {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }
        :root[data-theme="dark"] .card-header {
            background-color: var(--header-bg) !important;
            color: var(--header-text) !important;
        }
        :root[data-theme="dark"] .table tbody tr {
            background-color: var(--table-row-bg) !important;
            color: var(--text-color) !important;
        }
        :root[data-theme="dark"] .table tbody tr:nth-child(even) {
            background-color: var(--table-row-alt-bg) !important;
        }
        :root[data-theme="dark"] .table tbody td {
            color: var(--text-color) !important;
        }
        :root[data-theme="dark"] .table tbody td a {
            color: var(--info-window-link) !important;
        }

        :root[data-theme="dark"] .table,
        :root[data-theme="dark"] .table thead th,
        :root[data-theme="dark"] .table tbody tr,
        :root[data-theme="dark"] .table tbody td {
            background-color: #23272b !important;
            color: #fff !important;
            border-color: #495057 !important;
        }
        :root[data-theme="dark"] .table tbody tr:nth-child(even) {
            background-color: #2c3034 !important;
        }
        :root[data-theme="dark"] .table tbody td a {
            color: #66b3ff !important;
        }

.login-btn, #profileBtn {
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 1000;
  background: none;
  border: 2px solid #fff;
  color: #fff;
  border-radius: 25px;
  padding: 10px 24px;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.login-btn i, #profileBtn i {
  font-size: 1.3rem;
}

#profileModal .form-select {
  background-color: var(--form-bg);
  color: var(--form-text);
  border-color: var(--border-color);
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
}

#forgotPasswordModal .modal-content {
  background: #fff !important;
  color: #222 !important;
}
#forgotPasswordModal .form-control {
  background: #fff !important;
  color: #222 !important;
  border: 1px solid #ccc !important;
}
#forgotPasswordModal .form-label {
  color: #222 !important;
}
#forgotPasswordModal .btn-primary {
  background: #366092 !important;
  color: #fff !important;
  border: none !important;
}
#forgotPasswordModal .btn-primary:hover {
  background: #27496d !important;
}
#forgotPasswordModal .modal-title, #forgotPasswordModal p {
  color: #222 !important;
}

</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Lead Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <script src="{{ url_for('static', filename='GMaps.js') }}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=places" async defer></script>
</head>
<body>
    <button class="login-btn" id="authBtn" onclick="showAuthModal()" style="position: fixed; top: 1rem; right: 1rem; z-index: 1000; background: none; border: 2px solid #fff; color: #fff; border-radius: 25px; padding: 10px 24px; font-size: 1.1rem;">
        <i class="bi bi-person-circle"></i>
        <span id="authBtnText">Login</span>
    </button>
    <a href="/pricing" class="btn btn-outline-primary" style="position: fixed; top: 1rem; right: 10rem; z-index: 1000;">Pricing</a>

    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="authModalLabel">Login or Sign Up</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="authTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="true">Login</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup" type="button" role="tab" aria-controls="signup" aria-selected="false">Sign Up</button>
              </li>
            </ul>
            <div class="tab-content pt-3" id="authTabContent">
              <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                <form id="loginForm">
                  <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                  </div>
                  <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">Remember me</label>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Login</button>
                  <div class="text-center mt-3">
                    <a href="#" onclick="showForgotPasswordModal()" style="color: var(--info-window-link); text-decoration: none;">Forgot Password?</a>
                  </div>
                </form>
              </div>
              <div class="tab-pane fade" id="signup" role="tabpanel" aria-labelledby="signup-tab">
                <form id="signupForm">
                  <div class="mb-3">
                    <label for="signupEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="signupEmail" required>
                  </div>
                  <div class="mb-3">
                    <label for="signupPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="signupPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="signupConfirmPassword" required>
                  </div>
                  <div class="mb-3">
                    <label for="signupName" class="form-label">Name (Optional)</label>
                    <input type="text" class="form-control" id="signupName">
                  </div>
                  <div class="mb-3">
                    <label for="signupBusiness" class="form-label">Business (Optional)</label>
                    <input type="text" class="form-control" id="signupBusiness">
                  </div>
                  <div class="mb-3">
                    <label for="signupPhone" class="form-label">Phone (Optional)</label>
                    <input type="tel" class="form-control" id="signupPhone">
                  </div>
                  <button type="submit" class="btn btn-success w-100">Sign Up</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Password</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgotPasswordForm">
              <div class="mb-3">
                <label for="forgotPasswordEmail" class="form-label">Email address</label>
                <input type="email" class="form-control" id="forgotPasswordEmail" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Send Reset Link</button>
            </form>
            <div id="forgotPasswordAlert" class="alert mt-3" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-4">
        <h1 class="text-center mb-4">Business Lead Finder</h1>
        
        <div class="alert alert-danger" id="alert" style="display: none;"></div>
        
        <div class="search-container">
            <div class="search-form">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Search Parameters</h5>
                        <form id="searchForm">
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="e.g., New York">
                            </div>
                            <div class="mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state" placeholder="e.g., NY">
                            </div>
                            <div class="mb-3">
                                <label for="businessType" class="form-label">Business Type</label>
                                <input type="text" class="form-control" id="businessType" name="businessType" required>
                            </div>
                            <div class="mb-3">
                                <label for="radius" class="form-label">Search Radius (miles)</label>
                                <input type="number" class="form-control" id="radius" value="5" min="1" max="50">
                            </div>
                            <div class="mb-3" id="maxReviewsContainer" style="display: none;">
                                <label for="maxReviews" class="form-label">Filter by Maximum Reviews</label>
                                <input type="number" class="form-control" id="maxReviews" placeholder="e.g., 15">
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="usePin" checked>
                                <label class="form-check-label" for="usePin">Also search around dropped pin</label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">Search</button>
                                <button type="button" class="btn btn-secondary" id="clearPin">Clear Pin</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="map-wrapper">
                <div id="map"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Search Results</h5>
                            <button id="exportBtn" class="btn btn-success" disabled onclick="exportToGoogleSheets()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Export to Google Sheets
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="resultsTable" style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background-color: var(--table-header-bg);">
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Name</th>
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Address</th>
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Phone</th>
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Website</th>
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Rating</th>
                                        <th style="color: var(--table-header-text); padding: 1rem; border-right: 1px solid var(--border-color);">Reviews</th>
                                        <th style="color: var(--table-header-text); padding: 1rem;">Opening Hours</th>
                                    </tr>
                                </thead>
                                <tbody style="background-color: var(--table-bg);"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profileModalLabel">Your Profile & Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="profileTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                  <i class="bi bi-person-circle"></i> Profile
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">
                  <i class="bi bi-gear"></i> Settings
                </button>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content pt-3" id="profileTabContent">
              <!-- Profile Tab -->
              <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <form id="profileForm">
                  <div class="mb-3">
                    <label for="profileEmail" class="form-label">Email</label>
                    <input type="email" class="form-control" id="profileEmail" readonly>
                  </div>
                  <div class="mb-3">
                    <label for="profileName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="profileName">
                  </div>
                  <div class="mb-3">
                    <label for="profileBusiness" class="form-label">Business</label>
                    <input type="text" class="form-control" id="profileBusiness">
                  </div>
                  <div class="mb-3">
                    <label for="profilePhone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="profilePhone">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email Verification</label>
                    <div id="verificationStatus" class="d-flex align-items-center">
                      <span id="verificationIcon" class="me-2"></span>
                      <span id="verificationText"></span>
                    </div>
                    <button type="button" id="resendVerificationBtn" class="btn btn-outline-primary btn-sm mt-2" style="display: none;">
                      <i class="bi bi-envelope"></i> Resend Verification Email
                    </button>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Subscription</label>
                    <div id="subscriptionStatus">
                        <p><strong>Current Plan:</strong> <span id="currentPlan">N/A</span></p>
                        <p><strong>Trial Ends:</strong> <span id="trialEndsAt">N/A</span></p>
                    </div>
                    <button type="button" class="btn btn-info" id="manageSubscriptionBtn" style="display: none;">Manage Subscription</button>
                    <a href="/pricing" class="btn btn-primary" id="upgradeSubscriptionBtn" style="display: none;">Upgrade Plan</a>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">Save Profile</button>
                    <button type="button" class="btn btn-danger" onclick="logout()">Logout</button>
                  </div>
                </form>
              </div>
              
              <!-- Settings Tab -->
              <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <form id="settingsForm">
                  <!-- Search Preferences -->
                  <div class="card mb-3">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="bi bi-search"></i> Search Preferences</h6>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="defaultRadius" class="form-label">Default Search Radius (miles)</label>
                        <input type="number" class="form-control" id="defaultRadius" min="1" max="50" value="5">
                        <div class="form-text">This will be the default radius when you start a new search.</div>
                      </div>
                      <div class="mb-3">
                        <label for="defaultBusinessType" class="form-label">Default Business Type</label>
                        <input type="text" class="form-control" id="defaultBusinessType" placeholder="e.g., plumber, restaurant, salon">
                        <div class="form-text">This will be pre-filled when you start a new search.</div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="rememberLastSearch">
                        <label class="form-check-label" for="rememberLastSearch">
                          Remember last search parameters
                        </label>
                        <div class="form-text">Automatically fill in the last used search criteria.</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Display Preferences -->
                  <div class="card mb-3">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="bi bi-display"></i> Display Preferences</h6>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="resultsPerPage" class="form-label">Results per page</label>
                        <select class="form-select" id="resultsPerPage">
                          <option value="10">10 results</option>
                          <option value="25" selected>25 results</option>
                          <option value="50">50 results</option>
                          <option value="100">100 results</option>
                        </select>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showMapByDefault" checked>
                        <label class="form-check-label" for="showMapByDefault">
                          Show map by default
                        </label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Notification Settings -->
                  <div class="card mb-3">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="bi bi-bell"></i> Notifications</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                        <label class="form-check-label" for="emailNotifications">
                          Email notifications
                        </label>
                        <div class="form-text">Receive emails about account updates and important information.</div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="searchReminders">
                        <label class="form-check-label" for="searchReminders">
                          Search reminders
                        </label>
                        <div class="form-text">Get reminded about your saved searches.</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Account Settings -->
                  <div class="card mb-3">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Account Security</h6>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword">
                      </div>
                      <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword">
                      </div>
                      <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmNewPassword">
                      </div>
                      <button type="button" class="btn btn-warning" onclick="changePassword()">
                        <i class="bi bi-key"></i> Change Password
                      </button>
                    </div>
                  </div>
                  
                  <!-- Data Management -->
                  <div class="card mb-3">
                    <div class="card-header">
                      <h6 class="mb-0"><i class="bi bi-database"></i> Data Management</h6>
                    </div>
                    <div class="card-body">
                      <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info" onclick="exportUserData()">
                          <i class="bi bi-download"></i> Export My Data
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteAccount()">
                          <i class="bi bi-trash"></i> Delete Account
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">Save Settings</button>
                    <button type="button" class="btn btn-secondary" onclick="resetSettings()">Reset to Defaults</button>
                  </div>
                </form>
              </div>
            </div>
            
            <div id="profileAlert" class="alert mt-3" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Assistant Chat Widget -->
    <div id="aiAssistant" class="ai-assistant">
        <!-- Chat Head (Always Visible) -->
        <div id="chatHead" class="chat-head" onclick="toggleChat()">
            <div class="chat-head-icon">
                <i class="bi bi-robot"></i>
            </div>
            <div class="chat-head-status">
                <span class="status-dot"></span>
                <span class="status-text">AI Assistant</span>
            </div>
        </div>
        
        <!-- Chat Window (Hidden by Default) -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="bi bi-robot"></i>
                    <span>AI Assistant</span>
                </div>
                <button class="chat-close" onclick="toggleChat()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Hello! I'm your AI assistant. How can I help you with your business lead finding today?</p>
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" id="chatInput" placeholder="Type your message..." maxlength="500">
                    <button id="sendMessage" onclick="sendMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Styles -->
    <style>
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-head {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
        }
        
        .chat-head:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }
        
        .chat-head-icon {
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .chat-head-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .chat-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-window.active {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .message.user-message {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .ai-message .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .user-message .message-avatar {
            background: #0d6efd;
            color: white;
        }
        
        .message-content {
            max-width: 70%;
        }
        
        .message-content p {
            margin: 0;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .ai-message .message-content p {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }
        
        .user-message .message-content p {
            background: #0d6efd;
            color: white;
        }
        
        .chat-input {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e9ecef;
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        .input-group input:focus {
            border-color: #667eea;
        }
        
        .input-group button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-group button:hover {
            transform: scale(1.05);
        }
        
        .input-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-window {
                width: 300px;
                height: 400px;
                bottom: 60px;
                right: 0;
            }
            
            .chat-head {
                padding: 10px 15px;
                min-width: 120px;
            }
            
            .status-text {
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .ai-assistant {
                bottom: 15px;
                right: 15px;
            }
            
            .chat-window {
                width: 280px;
                height: 350px;
            }
        }
    </style>

    <!-- AI Assistant JavaScript -->
    <script>
        let isChatOpen = false;
        let isTyping = false;
        
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            const chatHead = document.getElementById('chatHead');
            
            if (isChatOpen) {
                chatWindow.classList.remove('active');
                chatHead.style.transform = 'translateY(0)';
            } else {
                chatWindow.classList.add('active');
                chatHead.style.transform = 'translateY(-5px)';
                document.getElementById('chatInput').focus();
            }
            
            isChatOpen = !isChatOpen;
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response
            isTyping = true;
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                const response = generateAIResponse(message);
                addMessage(response, 'ai');
                isTyping = false;
            }, 1000 + Math.random() * 2000);
        }
        
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'ai' ? '<i class="bi bi-robot"></i>' : '<i class="bi bi-person"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = `<p>${text}</p>`;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="bi bi-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<p><span class="typing-dots">AI is typing</span></p>';
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(content);
            messagesContainer.appendChild(typingDiv);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function generateAIResponse(userMessage) {
            const responses = {
                'hello': 'Hello! How can I help you with your business lead finding today?',
                'help': 'I can help you with:\n Finding business leads\n Understanding search features\n Account management\n Pricing questions\nWhat would you like to know?',
                'search': 'To search for business leads:\n1. Enter your location\n2. Choose business type\n3. Set search radius\n4. Click "Search"\nPremium users can also filter by review count!',
                'pricing': 'We offer three plans:\n Basic: $50/mo - 50 searches + 1 AI Assistant\n Premium: $150/mo - 150 searches + review filters + 1 AI Assistant\n Platinum: $500/mo - 500 searches + phone support + 2 AI Assistants\nAll plans include a 14-day free trial!',
                'admin': 'I\'m sorry, I don\'t have information about admin features. If you need assistance with your account or the platform, please contact our support team.',
                'export': 'To export results:\n1. Complete your search\n2. Click "Export to Google Sheets"\n3. Authorize Google access\n4. Results will be saved to your Google Drive!',
                'filter': 'Review count filtering is available for Premium and Platinum users. This helps you find businesses with fewer reviews, which often have more potential for partnerships.',
                'trial': 'All plans include a 14-day free trial with no credit card required. You can upgrade or cancel anytime during the trial period.',
                'support': 'For support:\n Email: support@businessleadfinder.com\n Check our FAQ section\n Use the contact form\nWe typically respond within 24 hours!'
            };
            
            // Check if user is admin, platinum, or premium
            const isAdmin = currentUser && currentUser.is_admin;
            const isPlatinum = currentUser && currentUser.current_plan === 'PLATINUM';
            const isPremium = currentUser && currentUser.current_plan === 'PREMIUM';
            const isBasic = currentUser && currentUser.current_plan === 'BASIC';
            
            const lowerMessage = userMessage.toLowerCase();
            
            // Admin AI Assistant - Unlimited capabilities
            if (isAdmin) {
                return generateAdminAIResponse(userMessage);
            }
            
            // Platinum AI Assistant - Enhanced capabilities (2 AI Assistants)
            if (isPlatinum) {
                return generatePlatinumAIResponse(userMessage);
            }
            
            // Premium AI Assistant - Standard capabilities (1 AI Assistant)
            if (isPremium) {
                return generatePremiumAIResponse(userMessage);
            }
            
            // Basic AI Assistant - Basic capabilities (1 AI Assistant)
            if (isBasic) {
                return generateBasicAIResponse(userMessage);
            }
            
            // Check for keywords and return appropriate response
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return responses.hello;
            } else if (lowerMessage.includes('help')) {
                return responses.help;
            } else if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return responses.search;
            } else if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('plan')) {
                return responses.pricing;
            } else if (lowerMessage.includes('admin')) {
                // Only provide admin info to admin users
                if (isAdmin) {
                    return 'Admin features include:\n User management\n System monitoring\n Advanced analytics\n Support tools\n Dashboard access\nYou have access to these features through your admin dashboard.';
                } else {
                    return responses.admin;
                }
            } else if (lowerMessage.includes('export') || lowerMessage.includes('google')) {
                return responses.export;
            } else if (lowerMessage.includes('filter') || lowerMessage.includes('review')) {
                return responses.filter;
            } else if (lowerMessage.includes('trial') || lowerMessage.includes('free')) {
                return responses.trial;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return responses.support;
            } else {
                return "I'm here to help with your business lead finding needs! You can ask me about:\n How to search for leads\n Pricing and plans\n Export features\n Account management\n Support options\nWhat would you like to know?";
            }
        }
        
        function generateBasicAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            const basicResponses = {
                'hello': 'Hello! I\'m your Basic AI Assistant. I can help you with:\n Basic business lead finding\n Search guidance and tips\n Account management help\n Export assistance\nWhat would you like to know?',
                'help': 'As your Basic AI Assistant, I can help you with:\n Understanding how to search for leads\n Basic search guidance\n Account and plan questions\n Export to Google Sheets help\n General platform support\nJust ask me anything!',
                'search': 'To search for business leads:\n1. Enter your location\n2. Choose business type\n3. Set search radius\n4. Click "Search"\nYou have 50 searches per month on your Basic plan.',
                'pricing': 'You\'re on our Basic plan ($50/mo) which includes:\n 50 searches per month\n Basic business lead finding\n Export to Google Sheets\n Email support\n 1 AI Assistant (that\'s me!)',
                'export': 'To export results:\n1. Complete your search\n2. Click "Export to Google Sheets"\n3. Authorize Google access\n4. Results will be saved to your Google Drive!',
                'filter': 'Review count filtering is available for Premium and Platinum users. You can upgrade to Premium to access this feature.',
                'trial': 'You\'re on our Basic plan with 50 searches per month. All plans include a 14-day free trial.',
                'support': 'For Basic support:\n Email support\n FAQ section\n Contact form\nContact: support@businessleadfinder.com'
            };
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return basicResponses.hello;
            } else if (lowerMessage.includes('help')) {
                return basicResponses.help;
            } else if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return basicResponses.search;
            } else if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('plan')) {
                return basicResponses.pricing;
            } else if (lowerMessage.includes('export') || lowerMessage.includes('google')) {
                return basicResponses.export;
            } else if (lowerMessage.includes('filter') || lowerMessage.includes('review')) {
                return basicResponses.filter;
            } else if (lowerMessage.includes('trial') || lowerMessage.includes('free')) {
                return basicResponses.trial;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return basicResponses.support;
            } else {
                return "I'm your Basic AI Assistant! I can help you with:\n Basic business lead finding\n Search guidance and tips\n Account management help\n Export assistance\nJust ask me anything!";
            }
        }
        
        function generatePremiumAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Premium AI Team capabilities
            if (lowerMessage.includes('team') || lowerMessage.includes('ai team') || lowerMessage.includes('manager')) {
                return handlePremiumAITeam(userMessage);
            }
            
            // Specific AI team member requests
            if (lowerMessage.includes('outsourcing') || lowerMessage.includes('outsource')) {
                return handleOutsourcingAI(userMessage);
            }
            
            if (lowerMessage.includes('copywriting') || lowerMessage.includes('copy') || lowerMessage.includes('content')) {
                return handleCopywritingAI(userMessage);
            }
            
            if (lowerMessage.includes('email') || lowerMessage.includes('emails')) {
                return handleEmailAI(userMessage);
            }
            
            if (lowerMessage.includes('seo') || lowerMessage.includes('search engine')) {
                return handleSEOAI(userMessage);
            }
            
            if (lowerMessage.includes('cold call') || lowerMessage.includes('cold calling') || lowerMessage.includes('calling')) {
                return handleColdCallingAI(userMessage);
            }
            
            const premiumResponses = {
                'hello': 'Hello! I\'m your Premium AI Team Manager. I oversee a team of 5 specialized AI assistants:\n\n **Your AI Team:**\n Outsourcing AI - Find and manage outsourcing opportunities\n Copywriting AI - Create compelling content and copy\n Email AI - Craft professional email campaigns\n SEO AI - Optimize for search engines\n Cold Calling AI - Generate cold calling strategies\n\nWhat would you like my team to help you with today?',
                'help': 'As your Premium AI Team Manager, I coordinate 5 specialized AIs:\n\n **Team Capabilities:**\n Outsourcing AI - Vendor research, cost analysis, contract management\n Copywriting AI - Marketing copy, website content, social media posts\n Email AI - Campaign creation, templates, automation\n SEO AI - Keyword research, optimization, analytics\n Cold Calling AI - Scripts, strategies, follow-up sequences\n\nJust tell me what you need, and I\'ll assign the right AI to help!',
                'search': 'To search for business leads:\n1. Enter your location\n2. Choose business type\n3. Set search radius\n4. Use review count filter (Premium feature!)\n5. Click "Search"\nYou have 150 searches per month on your Premium plan.',
                'pricing': 'You\'re on our Premium plan ($150/mo) which includes:\n 150 searches per month\n Filter by maximum review count\n Export to Google Sheets\n Priority email support\n AI Team (5 Specialized AIs + 1 Manager)',
                'export': 'To export results:\n1. Complete your search\n2. Click "Export to Google Sheets"\n3. Authorize Google access\n4. Results will be saved to your Google Drive!',
                'filter': 'You have access to review count filtering! This helps you find businesses with fewer reviews, which often have more potential for partnerships.',
                'trial': 'You\'re on our Premium plan with 150 searches per month and a full AI Team. All plans include a 14-day free trial.',
                'support': 'For Premium support:\n Priority email support\n Enhanced FAQ access\n Dedicated support team\nContact: premium-support@businessleadfinder.com'
            };
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return premiumResponses.hello;
            } else if (lowerMessage.includes('help')) {
                return premiumResponses.help;
            } else if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return premiumResponses.search;
            } else if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('plan')) {
                return premiumResponses.pricing;
            } else if (lowerMessage.includes('export') || lowerMessage.includes('google')) {
                return premiumResponses.export;
            } else if (lowerMessage.includes('filter') || lowerMessage.includes('review')) {
                return premiumResponses.filter;
            } else if (lowerMessage.includes('trial') || lowerMessage.includes('free')) {
                return premiumResponses.trial;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return premiumResponses.support;
            } else {
                return "I'm your Premium AI Team Manager! I coordinate 5 specialized AIs:\n Outsourcing AI - Vendor research and management\n Copywriting AI - Content creation and copywriting\n Email AI - Email campaigns and automation\n SEO AI - Search engine optimization\n Cold Calling AI - Cold calling strategies\n\nJust tell me what you need, and I'll assign the right AI to help!";
            }
        }
        
        function handlePremiumAITeam(userMessage) {
            return " **Your Premium AI Team:**\n\n **AI Team Manager (Me):**\n Coordinates all 5 specialized AIs\n Assigns tasks to the right AI\n Manages workflow and priorities\n Provides strategic oversight\n\n **Specialized AI Team Members:**\n\n1 **Outsourcing AI:**\n Vendor research and evaluation\n Cost analysis and comparison\n Contract negotiation assistance\n Quality control monitoring\n Performance tracking\n\n2 **Copywriting AI:**\n Marketing copy creation\n Website content development\n Social media posts\n Email copywriting\n Brand messaging\n\n3 **Email AI:**\n Email campaign creation\n Template development\n Automation sequences\n A/B testing strategies\n List segmentation\n\n4 **SEO AI:**\n Keyword research and analysis\n On-page optimization\n Content strategy development\n Analytics and reporting\n Technical SEO guidance\n\n5 **Cold Calling AI:**\n Call script development\n Prospect research\n Follow-up sequences\n Objection handling\n Conversion strategies\n\nJust tell me what you need, and I'll assign the right AI to help you!";
        }
        
        function handleOutsourcingAI(userMessage) {
            return " **Outsourcing AI at your service!**\n\nI specialize in:\n\n **Vendor Research:**\n Find qualified outsourcing partners\n Evaluate vendor capabilities\n Compare pricing and quality\n Check references and reviews\n Assess cultural fit\n\n **Cost Analysis:**\n Detailed cost breakdowns\n ROI calculations\n Hidden cost identification\n Budget optimization\n Payment structure analysis\n\n **Contract Management:**\n Contract template creation\n Terms and conditions review\n SLA development\n Risk assessment\n Legal compliance checks\n\n **Performance Monitoring:**\n Quality control metrics\n Delivery timeline tracking\n Communication protocols\n Issue resolution processes\n Continuous improvement\n\nWhat type of outsourcing do you need help with?";
        }
        
        function handleCopywritingAI(userMessage) {
            return " **Copywriting AI ready to create compelling content!**\n\nI specialize in:\n\n **Marketing Copy:**\n Website copy and landing pages\n Social media posts and ads\n Email marketing campaigns\n Product descriptions\n Brand messaging\n\n **Content Strategy:**\n Target audience analysis\n Tone and voice development\n Content calendar planning\n SEO-optimized writing\n Conversion-focused copy\n\n **Copy Optimization:**\n A/B testing strategies\n Conversion rate optimization\n Call-to-action development\n Value proposition crafting\n Emotional appeal techniques\n\n **Creative Writing:**\n Storytelling and narratives\n Engaging headlines\n Compelling introductions\n Persuasive conclusions\n Brand storytelling\n\nWhat type of copy do you need help creating?";
        }
        
        function handleEmailAI(userMessage) {
            return " **Email AI here to boost your email campaigns!**\n\nI specialize in:\n\n **Campaign Creation:**\n Email sequence development\n Welcome series design\n Nurture campaign creation\n Promotional email strategies\n Newsletter templates\n\n **Template Development:**\n Professional email templates\n Industry-specific designs\n Mobile-responsive layouts\n Brand-consistent styling\n Call-to-action optimization\n\n **Automation Sequences:**\n Drip campaign setup\n Trigger-based emails\n Behavioral automation\n Lead scoring integration\n Re-engagement campaigns\n\n **A/B Testing:**\n Subject line testing\n Content optimization\n Send time analysis\n List segmentation\n Performance tracking\n\n **List Management:**\n Segmentation strategies\n List cleaning and hygiene\n Opt-in optimization\n Compliance management\n Growth strategies\n\nWhat email campaign do you need help with?";
        }
        
        function handleSEOAI(userMessage) {
            return " **SEO AI ready to boost your search rankings!**\n\nI specialize in:\n\n **Keyword Research:**\n High-value keyword identification\n Search volume analysis\n Competition assessment\n Long-tail keyword discovery\n Local SEO keywords\n\n **Content Strategy:**\n SEO-optimized content creation\n Topic cluster development\n Content gap analysis\n Featured snippet optimization\n Content calendar planning\n\n **Technical SEO:**\n Site structure optimization\n Page speed improvement\n Mobile optimization\n Schema markup implementation\n XML sitemap creation\n\n **Analytics & Reporting:**\n Search performance tracking\n Keyword ranking monitoring\n Traffic analysis\n Conversion tracking\n Competitor analysis\n\n **On-Page Optimization:**\n Meta title and description\n Header tag optimization\n Image alt text\n Internal linking\n URL structure\n\nWhat SEO aspect do you need help with?";
        }
        
        function handleColdCallingAI(userMessage) {
            return " **Cold Calling AI ready to boost your sales!**\n\nI specialize in:\n\n **Script Development:**\n Opening line creation\n Value proposition crafting\n Objection handling scripts\n Closing techniques\n Follow-up sequences\n\n **Prospect Research:**\n Target company identification\n Decision maker research\n Company background analysis\n Pain point identification\n Timing optimization\n\n **Call Strategy:**\n Call timing optimization\n Call volume planning\n Territory management\n Lead qualification\n Pipeline development\n\n **Communication Skills:**\n Active listening techniques\n Question formulation\n Value proposition delivery\n Objection handling\n Closing strategies\n\n **Follow-up Sequences:**\n Multi-touch campaigns\n Email follow-ups\n LinkedIn outreach\n Voicemail strategies\n Persistence planning\n\nWhat cold calling aspect do you need help with?";
        }
        
        function generateAdminAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Admin AI can perform unlimited searches
            if (lowerMessage.includes('search for') || lowerMessage.includes('find') || lowerMessage.includes('look for')) {
                return handleAdminSearch(userMessage);
            }
            
            // Admin AI can create multiple AI assistants
            if (lowerMessage.includes('create ai') || lowerMessage.includes('new assistant') || lowerMessage.includes('make assistant')) {
                return handleCreateAIAssistant(userMessage);
            }
            
            // Admin AI can manage users
            if (lowerMessage.includes('user') || lowerMessage.includes('manage') || lowerMessage.includes('account')) {
                return handleAdminUserManagement(userMessage);
            }
            
            // Admin AI can provide system insights
            if (lowerMessage.includes('system') || lowerMessage.includes('analytics') || lowerMessage.includes('stats')) {
                return handleAdminSystemInsights(userMessage);
            }
            
            // Admin AI can perform advanced vetting
            if (lowerMessage.includes('vet') || lowerMessage.includes('analyze') || lowerMessage.includes('quality')) {
                return handleAdminVetting(userMessage);
            }
            
            // Enhanced responses for Admin users
            const adminResponses = {
                'hello': 'Hello! I\'m your Admin AI Assistant with unlimited capabilities. I can help you with:\n Unlimited business lead searches\n Advanced result vetting and analysis\n User management and system monitoring\n Creating multiple AI assistants\n System analytics and insights\n Custom search strategies\nWhat would you like me to help you with today?',
                'help': 'As your Admin AI Assistant, I have unlimited access to:\n Unlimited business lead searches (no limits)\n Advanced result vetting and analysis\n User management and account control\n System monitoring and analytics\n Creating and managing multiple AI assistants\n Custom search strategies and automation\n Full export capabilities\n Priority processing for all operations\nJust tell me what you need!',
                'search': 'I can perform unlimited searches for you with no restrictions! Just tell me:\n What type of business you\'re looking for\n The location or area\n Any specific criteria (reviews, ratings, etc.)\nI\'ll search, vet the results, and provide you with comprehensive analysis.',
                'pricing': 'As an admin, you have unlimited access to all features:\n Unlimited searches (no monthly limits)\n Advanced AI-powered lead vetting\n Full system analytics\n User management capabilities\n Multiple AI assistant creation\n Priority processing\n Complete export capabilities',
                'admin': 'Admin features include:\n User management and control\n System monitoring and analytics\n Advanced search capabilities\n Multiple AI assistant creation\n Unlimited searches and exports\n Priority processing\n Full system access\nYou have complete control over the platform.',
                'export': 'I can automatically export unlimited search results to Google Sheets! Just ask me to search for something, and I\'ll handle the export process with no restrictions.',
                'filter': 'I can apply unlimited advanced filtering during searches, including:\n Review count analysis\n Rating thresholds\n Business type matching\n Location optimization\n Quality scoring\n Custom criteria\nJust tell me your criteria!',
                'trial': 'As an admin, you have unlimited access to all features with no restrictions or trial limitations.',
                'support': 'For Admin support:\n Direct system access\n Unlimited capabilities\n Priority processing\n Full analytics access\n Multiple AI assistant management\nContact: admin-support@businessleadfinder.com'
            };
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return adminResponses.hello;
            } else if (lowerMessage.includes('help')) {
                return adminResponses.help;
            } else if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return adminResponses.search;
            } else if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('plan')) {
                return adminResponses.pricing;
            } else if (lowerMessage.includes('admin')) {
                return adminResponses.admin;
            } else if (lowerMessage.includes('export') || lowerMessage.includes('google')) {
                return adminResponses.export;
            } else if (lowerMessage.includes('filter') || lowerMessage.includes('review')) {
                return adminResponses.filter;
            } else if (lowerMessage.includes('trial') || lowerMessage.includes('free')) {
                return adminResponses.trial;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return adminResponses.support;
            } else {
                return "I'm your Admin AI Assistant with unlimited capabilities! I can help you with:\n Unlimited business lead searches\n Advanced result vetting and analysis\n User management and system control\n Creating multiple AI assistants\n System analytics and insights\n Custom automation strategies\nJust tell me what you need!";
            }
        }
        
        function handleAdminSearch(userMessage) {
            // Extract search parameters from user message
            const searchTerms = extractSearchTerms(userMessage);
            
            if (!searchTerms.location || !searchTerms.businessType) {
                return "I'd be happy to perform unlimited searches for you! Please tell me:\n What type of business you're looking for\n The location or area\n Any specific criteria (optional)\n\nFor example: 'Search for restaurants in New York' or 'Find coffee shops in Los Angeles'\n\nAs an admin, you have unlimited search capabilities with no restrictions!";
            }
            
            return `I'll perform an unlimited search for ${searchTerms.businessType} in ${searchTerms.location} for you!\n\n **Admin Search Parameters:**\n Business Type: ${searchTerms.businessType}\n Location: ${searchTerms.location}\n Radius: ${searchTerms.radius || '5 miles'}\n Max Reviews: ${searchTerms.maxReviews || 'No limit'}\n Search Limit: UNLIMITED\n\nI'll analyze the results and provide you with comprehensive insights, including:\n Advanced quality scoring\n Partnership potential analysis\n Contact information verification\n Business stability assessment\n Market positioning analysis\n Risk assessment\n Growth potential evaluation\n\nAs an admin, you have unlimited search capabilities with priority processing!`;
        }
        
        function handleCreateAIAssistant(userMessage) {
            return "I can help you create multiple AI assistants! Here's what I can do:\n\n **AI Assistant Creation:**\n Create specialized AI assistants for different tasks\n Customize AI responses and capabilities\n Set up automated workflows\n Configure AI for specific user groups\n Create AI assistants for different business types\n\n **Assistant Types Available:**\n Lead Generation AI\n Customer Support AI\n Sales Analysis AI\n Market Research AI\n Quality Control AI\n Export Management AI\n\n **Management Features:**\n Monitor all AI assistants\n Track performance metrics\n Update AI capabilities\n Manage AI permissions\n Coordinate multiple AIs\n\nJust tell me what type of AI assistant you'd like to create!";
        }
        
        function handleAdminUserManagement(userMessage) {
            return "I can help you manage users and accounts! Here's what I can do:\n\n **User Management:**\n View all user accounts\n Modify user permissions\n Upgrade/downgrade user plans\n Reset user passwords\n Monitor user activity\n Manage user subscriptions\n\n **Account Control:**\n User analytics and insights\n Usage tracking and reporting\n Billing management\n Support ticket management\n User communication tools\n Account verification tools\n\n **Admin Tools:**\n Bulk user operations\n Automated user management\n User data export\n Account recovery tools\n User activity monitoring\n Security management\n\nJust tell me what user management task you need help with!";
        }
        
        function handleAdminSystemInsights(userMessage) {
            return "I can provide comprehensive system insights and analytics! Here's what I analyze:\n\n **System Analytics:**\n Total user count and growth\n Search usage statistics\n Plan distribution analysis\n Revenue tracking and trends\n System performance metrics\n Error rate monitoring\n\n **User Insights:**\n User behavior patterns\n Feature usage analytics\n Conversion rate analysis\n User satisfaction metrics\n Support ticket analysis\n User retention data\n\n **Business Intelligence:**\n Market trend analysis\n Competitive positioning\n Revenue optimization\n Feature adoption rates\n User engagement metrics\n Growth opportunity identification\n\nJust ask me for specific system insights or analytics!";
        }
        
        function handleAdminVetting(userMessage) {
            return "I can perform advanced vetting and analysis with unlimited capabilities! Here's what I evaluate:\n\n **Advanced Vetting Criteria:**\n Comprehensive review analysis\n Rating consistency and trends\n Business age and stability assessment\n Partnership potential scoring\n Contact accessibility verification\n Market positioning analysis\n Financial stability indicators\n Growth trajectory assessment\n\n **Admin Analysis Includes:**\n Quality score (1-10) with detailed breakdown\n Partnership likelihood with confidence levels\n Risk assessment with mitigation strategies\n Growth potential with market analysis\n Contact readiness with response probability\n Competitive positioning analysis\n Market saturation assessment\n Expansion opportunity evaluation\n\n **Advanced Insights:**\n Industry trend analysis\n Market opportunity identification\n Risk factor assessment\n Strategic partnership recommendations\n Contact strategy optimization\n Follow-up timing recommendations\n\nAs an admin, I have unlimited vetting capabilities with priority processing!";
        }
        
        function generatePlatinumAIResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            // Platinum AI can perform automated searches
            if (lowerMessage.includes('search for') || lowerMessage.includes('find') || lowerMessage.includes('look for')) {
                return handlePlatinumSearch(userMessage);
            }
            
            // Platinum AI can vet and analyze results
            if (lowerMessage.includes('vet') || lowerMessage.includes('analyze') || lowerMessage.includes('quality')) {
                return handlePlatinumVetting(userMessage);
            }
            
            // Platinum AI can provide advanced insights
            if (lowerMessage.includes('insight') || lowerMessage.includes('analysis') || lowerMessage.includes('recommend')) {
                return handlePlatinumInsights(userMessage);
            }
            
            // Enhanced responses for Platinum users
            const platinumResponses = {
                'hello': 'Hello! I\'m your Platinum AI Assistant. I can help you with:\n Automated business lead searches\n Result vetting and analysis\n Advanced insights and recommendations\n Custom search strategies\nWhat would you like me to help you with today?',
                'help': 'As your Platinum AI Assistant, I can:\n Search for business leads automatically\n Vet and analyze search results\n Provide advanced insights\n Create custom search strategies\n Export results to Google Sheets\n Monitor lead quality and potential\nJust tell me what you\'re looking for!',
                'search': 'I can perform automated searches for you! Just tell me:\n What type of business you\'re looking for\n The location or area\n Any specific criteria (reviews, ratings, etc.)\nI\'ll search, vet the results, and provide you with the best leads.',
                'pricing': 'You\'re on our Platinum plan ($500/mo) which includes:\n 500 searches per month\n AI-powered lead vetting\n Advanced analytics\n Phone & email support\n Automated search capabilities\n Priority processing',
                'admin': 'I\'m sorry, I don\'t have information about admin features. If you need assistance with your account or the platform, please contact our support team.',
                'export': 'I can automatically export your search results to Google Sheets! Just ask me to search for something, and I\'ll handle the export process for you.',
                'filter': 'I can apply advanced filtering during searches, including:\n Review count analysis\n Rating thresholds\n Business type matching\n Location optimization\n Quality scoring\nJust tell me your criteria!',
                'trial': 'You\'re on our Platinum plan, so you have full access to all features including AI-powered searches and vetting.',
                'support': 'For Platinum support:\n Priority phone support\n Dedicated account manager\n 24/7 email support\n Custom training sessions\nContact: platinum-support@businessleadfinder.com'
            };
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return platinumResponses.hello;
            } else if (lowerMessage.includes('help')) {
                return platinumResponses.help;
            } else if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
                return platinumResponses.search;
            } else if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('plan')) {
                return platinumResponses.pricing;
            } else if (lowerMessage.includes('admin')) {
                return platinumResponses.admin;
            } else if (lowerMessage.includes('export') || lowerMessage.includes('google')) {
                return platinumResponses.export;
            } else if (lowerMessage.includes('filter') || lowerMessage.includes('review')) {
                return platinumResponses.filter;
            } else if (lowerMessage.includes('trial') || lowerMessage.includes('free')) {
                return platinumResponses.trial;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return platinumResponses.support;
            } else {
                return "I'm your Platinum AI Assistant! I can help you with:\n Automated business lead searches\n Advanced result vetting and analysis\n Custom search strategies\n Quality scoring and insights\n Automated exports\nJust tell me what you're looking for!";
            }
        }
        
        function handlePlatinumSearch(userMessage) {
            // Extract search parameters from user message
            const searchTerms = extractSearchTerms(userMessage);
            
            if (!searchTerms.location || !searchTerms.businessType) {
                return "I'd be happy to search for business leads for you! Please tell me:\n What type of business you're looking for\n The location or area\n Any specific criteria (optional)\n\nFor example: 'Search for restaurants in New York' or 'Find coffee shops in Los Angeles'";
            }
            
            return `I'll search for ${searchTerms.businessType} in ${searchTerms.location} for you!\n\n **Search Parameters:**\n Business Type: ${searchTerms.businessType}\n Location: ${searchTerms.location}\n Radius: ${searchTerms.radius || '5 miles'}\n Max Reviews: ${searchTerms.maxReviews || 'No limit'}\n\nI'll analyze the results and provide you with the best leads, including:\n Quality scoring\n Partnership potential\n Contact information\n Business insights\n\nWould you like me to proceed with this search?`;
        }
        
        function handlePlatinumVetting(userMessage) {
            return "I can vet and analyze search results for you! I'll evaluate each business based on:\n\n **Vetting Criteria:**\n Review count and quality\n Rating consistency\n Business age and stability\n Partnership potential\n Contact accessibility\n Market positioning\n\n **Analysis Includes:**\n Quality score (1-10)\n Partnership likelihood\n Risk assessment\n Growth potential\n Contact readiness\n\nJust ask me to search for something, and I'll provide fully vetted results!";
        }
        
        function handlePlatinumInsights(userMessage) {
            return "I can provide advanced insights and recommendations! Here's what I analyze:\n\n **Market Insights:**\n Industry trends in your target area\n Competition analysis\n Market saturation levels\n Growth opportunities\n\n **Lead Quality Analysis:**\n Partnership potential scoring\n Contact readiness assessment\n Business stability indicators\n Expansion opportunities\n\n **Strategic Recommendations:**\n Best approach strategies\n Optimal contact timing\n Partnership proposal suggestions\n Risk mitigation strategies\n\nJust tell me what you're looking for, and I'll provide comprehensive insights!";
        }
        
        function extractSearchTerms(userMessage) {
            const terms = {
                location: '',
                businessType: '',
                radius: '5',
                maxReviews: null
            };
            
            // Extract location (common patterns)
            const locationPatterns = [
                /(?:in|at|near|around)\s+([A-Za-z\s,]+?)(?:\s|$)/i,
                /(?:search|find|look)\s+(?:for\s+)?[^in]*?\s+(?:in|at|near)\s+([A-Za-z\s,]+?)(?:\s|$)/i
            ];
            
            for (const pattern of locationPatterns) {
                const match = userMessage.match(pattern);
                if (match) {
                    terms.location = match[1].trim();
                    break;
                }
            }
            
            // Extract business type
            const businessPatterns = [
                /(?:search|find|look)\s+(?:for\s+)?([^in]*?)(?:\s+in|\s+at|\s+near|$)/i,
                /(?:restaurants?|coffee\s+shops?|gyms?|salons?|dentists?|lawyers?|accountants?|plumbers?|electricians?|contractors?|real\s+estate|insurance|banks?|pharmacies?|doctors?|dentists?|veterinarians?|pet\s+shops?|bookstores?|libraries?|schools?|universities?|hospitals?|clinics?|spas?|massage|yoga|fitness|gyms?|studios?|shops?|stores?|businesses?|companies?|offices?)/gi
            ];
            
            for (const pattern of businessPatterns) {
                const match = userMessage.match(pattern);
                if (match) {
                    terms.businessType = match[1] || match[0];
                    break;
                }
            }
            
            // Extract radius
            const radiusMatch = userMessage.match(/(\d+)\s*(?:mile|miles|mi)/i);
            if (radiusMatch) {
                terms.radius = radiusMatch[1];
            }
            
            // Extract max reviews
            const reviewMatch = userMessage.match(/(\d+)\s*(?:review|reviews)/i);
            if (reviewMatch) {
                terms.maxReviews = reviewMatch[1];
            }
            
            return terms;
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Global variables for user state
        let currentUser = null;
        let isAuthenticated = false;

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Check if user is authenticated
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                if (data.is_logged_in) {
                    currentUser = data.user;
                    isAuthenticated = true;
                    updateAuthButton();
                    loadUserSettingsForSearch();
                    updateSubscriptionStatus(data.user);
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    updateAuthButton();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        // Load user settings for search form
        async function loadUserSettingsForSearch() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.settings;
                    
                    // Apply default settings to search form
                    if (settings.default_radius) {
                        document.getElementById('radius').value = settings.default_radius;
                    }
                    
                    if (settings.default_business_type) {
                        document.getElementById('businessType').value = settings.default_business_type;
                    }
                    
                    // Remember last search if enabled
                    if (settings.remember_last_search && settings.last_search_city) {
                        document.getElementById('city').value = settings.last_search_city || '';
                        document.getElementById('state').value = settings.last_search_state || '';
                        document.getElementById('businessType').value = settings.last_search_business_type || settings.default_business_type || '';
                        document.getElementById('radius').value = settings.last_search_radius || settings.default_radius || 5;
                    }
                }
            } catch (error) {
                console.error('Error loading search settings:', error);
            }
        }

        // Update the auth button based on authentication status
        function updateAuthButton() {
            const authBtn = document.getElementById('authBtn');
            const authBtnText = document.getElementById('authBtnText');
            
            console.log(' updateAuthButton called - isAuthenticated:', isAuthenticated, 'currentUser:', currentUser);
            
            if (isAuthenticated && currentUser) {
                authBtnText.textContent = currentUser.name || currentUser.email;
                authBtn.onclick = showProfileModal;
                console.log(' Auth button updated to show profile for:', currentUser.name || currentUser.email);
            } else {
                authBtnText.textContent = 'Login';
                authBtn.onclick = showAuthModal;
                console.log(' Auth button updated to show login');
            }
        }

        // Show authentication modal
        function showAuthModal() {
            const authModal = new bootstrap.Modal(document.getElementById('authModal'));
            authModal.show();
        }

        // Show profile modal
        function showProfileModal() {
            if (!isAuthenticated) {
                showAuthModal();
                return;
            }
            
            // Populate profile form with current user data
            document.getElementById('profileEmail').value = currentUser.email;
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileBusiness').value = currentUser.business || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            
            // Update verification status
            updateVerificationStatus();
            
            // Load user settings
            loadUserSettings();
            
            updateSubscriptionStatus(currentUser);
            
            const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
            profileModal.show();
        }

        // Show forgot password modal
        function showForgotPasswordModal() {
            const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
            if (authModal) {
                authModal.hide();
            }
            
            const forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
            forgotPasswordModal.show();
        }

        // Update verification status display
        function updateVerificationStatus() {
            const verificationIcon = document.getElementById('verificationIcon');
            const verificationText = document.getElementById('verificationText');
            const resendBtn = document.getElementById('resendVerificationBtn');
            
            if (currentUser.is_verified) {
                verificationIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                verificationText.textContent = 'Email verified';
                verificationText.className = 'text-success';
                resendBtn.style.display = 'none';
            } else {
                verificationIcon.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';
                verificationText.textContent = 'Email not verified';
                verificationText.className = 'text-warning';
                resendBtn.style.display = 'block';
            }
        }

        function updateSubscriptionStatus(user) {
            console.log(' updateSubscriptionStatus called with user:', user);
            const statusDiv = document.getElementById('subscriptionStatus');
            const manageBtn = document.getElementById('manageSubscriptionBtn');
            const upgradeBtn = document.getElementById('upgradeSubscriptionBtn');
            const currentPlanSpan = document.getElementById('currentPlan');
            const trialEndsSpan = document.getElementById('trialEndsAt');

            // Always hide buttons by default and remove any existing admin dashboard links to prevent duplication
            manageBtn.style.display = 'none';
            upgradeBtn.style.display = 'none';
            const existingAdminLinks = statusDiv.querySelectorAll('a[href="/admin/dashboard"]');
            existingAdminLinks.forEach(link => link.remove());

            if (user.is_admin) {
                console.log(' Admin user detected:', user.email);
                console.log(' User is_admin:', user.is_admin);
                console.log(' User current_plan:', user.current_plan);
                currentPlanSpan.textContent = 'Admin Access';
                trialEndsSpan.textContent = 'Unlimited';
                
                // Show max reviews filter for admin users
                const maxReviewsContainer = document.getElementById('maxReviewsContainer');
                if (maxReviewsContainer) {
                    maxReviewsContainer.style.display = 'block';
                    console.log(' Max reviews filter shown for admin user');
                } else {
                    console.log(' Max reviews container not found');
                }
                
                const adminLink = `<a href="/admin/dashboard" class="btn btn-warning mt-2">Admin Dashboard</a>`;
                statusDiv.insertAdjacentHTML('beforeend', adminLink);
                console.log(' Admin dashboard link added');
                return; // Exit here for admins, preventing other logic from running
            }

            if (user.current_plan) {
                currentPlanSpan.textContent = user.current_plan.charAt(0).toUpperCase() + user.current_plan.slice(1).toLowerCase();
                trialEndsSpan.textContent = 'N/A';
                manageBtn.style.display = 'block';
                if (user.current_plan === 'PREMIUM' || user.current_plan === 'PLATINUM') {
                    const maxReviewsContainer = document.getElementById('maxReviewsContainer');
                    if (maxReviewsContainer) {
                        maxReviewsContainer.style.display = 'block';
                        console.log(` Max reviews filter shown for ${user.current_plan} user`);
                    } else {
                        console.log(' Max reviews container not found');
                    }
                }
            } else if (user.trial_ends_at) {
                const trialEndDate = new Date(user.trial_ends_at);
                const now = new Date();
                const diffTime = trialEndDate - now;
                if (diffTime > 0) {
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    currentPlanSpan.textContent = 'Free Trial';
                    trialEndsSpan.textContent = `${diffDays} days remaining`;
                    upgradeBtn.style.display = 'block';
                } else {
                    currentPlanSpan.textContent = 'Free Trial Expired';
                    trialEndsSpan.textContent = 'N/A';
                    upgradeBtn.style.display = 'block';
                }
            } else {
                currentPlanSpan.textContent = 'None';
                trialEndsSpan.textContent = 'N/A';
                upgradeBtn.style.display = 'block';
                upgradeBtn.textContent = 'Choose a Plan';
            }
        }

        document.getElementById('manageSubscriptionBtn').addEventListener('click', function() {
            fetch('/api/create-portal-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert(data.error || 'Could not open subscription management.');
                }
            })
            .catch(error => {
                console.error('Error creating portal session:', error);
                alert('An error occurred. Please try again.');
            });
        });

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, remember })
                });
                
                const data = await response.json();
                
                if (response.ok && data.message) {
                    // Login successful
                    isAuthenticated = true;
                    updateAuthButton();
                    checkAuthStatus();
                    
                    // Close modal and show success message
                    const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                    authModal.hide();
                    
                    // Clear form
                    document.getElementById('loginForm').reset();
                    
                    alert('Login successful!');
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('An error occurred during login');
            }
        });

        // Handle signup form submission
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const name = document.getElementById('signupName').value;
            const business = document.getElementById('signupBusiness').value;
            const phone = document.getElementById('signupPhone').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, name, business, phone })
                });
                
                const data = await response.json();
                
                if (response.ok && data.message) {
                    // Registration successful
                    isAuthenticated = true;
                    updateAuthButton();
                    
                    // Close modal and show success message
                    const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                    authModal.hide();
                    
                    // Clear form
                    document.getElementById('signupForm').reset();
                    
                    alert('Registration successful!');
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('An error occurred during registration');
            }
        });

        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('profileName').value;
            const business = document.getElementById('profileBusiness').value;
            const phone = document.getElementById('profilePhone').value;
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, business, phone })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateAuthButton();
                    
                    // Show success message
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                    alertDiv.style.display = 'block';
                    
                    // Hide alert after 3 seconds
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'Profile update failed');
                    alertDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Profile update error:', error);
                const alertDiv = document.getElementById('profileAlert');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> An error occurred while updating profile';
                alertDiv.style.display = 'block';
            }
        });

        // Handle logout
        async function logout() {
            try {
                console.log(' Logout attempt started');
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                console.log(' Logout response:', response.status, data);
                
                if (response.ok) {
                    console.log(' Logout successful, updating UI');
                    currentUser = null;
                    isAuthenticated = false;
                    updateAuthButton();
                    
                    // Close profile modal
                    const profileModal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
                    if (profileModal) {
                        profileModal.hide();
                    }
                    
                    // Refresh auth status to ensure UI is properly updated
                    await checkAuthStatus();
                    
                    alert('Logout successful!');
                } else {
                    console.log(' Logout failed:', data.error);
                    alert(data.error || 'Logout failed');
                }
            } catch (error) {
                console.error(' Logout error:', error);
                alert('An error occurred during logout');
            }
        }

        // Handle forgot password form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgotPasswordEmail').value;
            const alertDiv = document.getElementById('forgotPasswordAlert');
            
            try {
                const response = await fetch('/api/request-password-reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                    alertDiv.style.display = 'block';
                    
                    // Clear form
                    document.getElementById('forgotPasswordForm').reset();
                    
                    // Close modal after 3 seconds
                    setTimeout(() => {
                        const forgotPasswordModal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
                        if (forgotPasswordModal) {
                            forgotPasswordModal.hide();
                        }
                    }, 3000);
                } else {
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'Failed to send reset email');
                    alertDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Password reset request error:', error);
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> An error occurred while sending reset email';
                alertDiv.style.display = 'block';
            }
        });

        // Handle resend verification email
        document.getElementById('resendVerificationBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/send-verification-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                    alertDiv.style.display = 'block';
                    
                    // Hide alert after 3 seconds
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'Failed to send verification email');
                    alertDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                const alertDiv = document.getElementById('profileAlert');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> An error occurred while sending verification email';
                alertDiv.style.display = 'block';
            }
        });

        // Load user settings
        async function loadUserSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.settings;
                    
                    // Populate settings form
                    document.getElementById('defaultRadius').value = settings.default_radius || 5;
                    document.getElementById('defaultBusinessType').value = settings.default_business_type || '';
                    document.getElementById('rememberLastSearch').checked = settings.remember_last_search || false;
                    document.getElementById('resultsPerPage').value = settings.results_per_page || 25;
                    document.getElementById('showMapByDefault').checked = settings.show_map_by_default !== false;
                    document.getElementById('emailNotifications').checked = settings.email_notifications !== false;
                    document.getElementById('searchReminders').checked = settings.search_reminders || false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save user settings
        async function saveSettings() {
            try {
                const settings = {
                    default_radius: parseInt(document.getElementById('defaultRadius').value),
                    default_business_type: document.getElementById('defaultBusinessType').value,
                    remember_last_search: document.getElementById('rememberLastSearch').checked,
                    results_per_page: parseInt(document.getElementById('resultsPerPage').value),
                    show_map_by_default: document.getElementById('showMapByDefault').checked,
                    email_notifications: document.getElementById('emailNotifications').checked,
                    search_reminders: document.getElementById('searchReminders').checked
                };
                
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                    alertDiv.style.display = 'block';
                    
                    // Hide alert after 3 seconds
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 3000);
                } else {
                    const alertDiv = document.getElementById('profileAlert');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'Failed to save settings');
                    alertDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                const alertDiv = document.getElementById('profileAlert');
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> An error occurred while saving settings';
                alertDiv.style.display = 'block';
            }
        }

        // Change password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('Please fill in all password fields');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }
            
            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Password changed successfully!');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    alert(data.error || 'Failed to change password');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('An error occurred while changing password');
            }
        }

        // Export user data
        async function exportUserData() {
            try {
                const response = await fetch('/api/export-data');
                const data = await response.json();
                
                if (data.success) {
                    // Create and download JSON file
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `user_data_${new Date().toISOString().slice(0,19).replace(/[:]/g, '')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    
                    alert('Data exported successfully!');
                } else {
                    alert(data.error || 'Failed to export data');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('An error occurred while exporting data');
            }
        }

        // Delete account
        async function deleteAccount() {
            const password = prompt('Please enter your password to confirm account deletion:');
            
            if (!password) {
                return;
            }
            
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Account deleted successfully!');
                    // Redirect to home page
                    window.location.href = '/';
                } else {
                    alert(data.error || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('An error occurred while deleting account');
            }
        }

        // Reset settings to defaults
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                document.getElementById('defaultRadius').value = 5;
                document.getElementById('defaultBusinessType').value = '';
                document.getElementById('rememberLastSearch').checked = false;
                document.getElementById('resultsPerPage').value = 25;
                document.getElementById('showMapByDefault').checked = true;
                document.getElementById('emailNotifications').checked = true;
                document.getElementById('searchReminders').checked = false;
                
                // Save the reset settings
                saveSettings();
            }
        }

        // Handle settings form submission
        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveSettings();
        });
    </script>
</body>
</html>