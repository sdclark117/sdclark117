<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Lead Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        :root[data-theme="light"] {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --header-bg: #366092;
            --header-text: #ffffff;
            --hover-bg: #2c4d73;
            --table-header-bg: #366092;
            --table-header-text: #ffffff;
            --table-row-hover: #f8f9fa;
            --info-window-bg: #ffffff;
            --info-window-text: #212529;
            --info-window-link: #0d6efd;
            --table-bg: #ffffff;
            --form-bg: #ffffff;
            --form-text: #212529;
            --alert-bg: #f8f9fa;
            --alert-text: #212529;
            --map-heading-bg: #f8f9fa;
            --map-heading-text: #212529;
        }

        :root[data-theme="dark"] {
            --bg-color: #212529;
            --card-bg: #2c3034;
            --text-color: #f8f9fa;
            --border-color: #495057;
            --header-bg: #1a1d20;
            --header-text: #ffffff;
            --hover-bg: #0d6efd;
            --table-header-bg: #343a40;
            --table-header-text: #ffffff;
            --table-row-hover: #343a40;
            --info-window-bg: #212529;
            --info-window-text: #f8f9fa;
            --info-window-link: #0d6efd;
            --table-bg: #212529;
            --form-bg: #212529;
            --form-text: #f8f9fa;
            --alert-bg: #343a40;
            --alert-text: #f8f9fa;
            --map-heading-bg: #343a40;
            --map-heading-text: #f8f9fa;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--card-bg);
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }

        .card-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
            transition: background-color 0.3s ease;
        }

        .form-control, .form-select {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--hover-bg);
            box-shadow: 0 0 0 0.25rem rgba(54, 96, 146, 0.25);
        }

        .btn-primary {
            background-color: var(--header-bg);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--hover-bg);
        }

        .table {
            background-color: var(--table-bg);
            color: var(--table-text);
            border-radius: 10px;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .table thead th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            border: none;
            transition: background-color 0.3s ease;
        }

        .table tbody tr:hover {
            background-color: var(--table-row-hover);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }

        .results-section {
            display: none;
            margin-top: 2rem;
        }

        .alert {
            border-radius: 10px;
            display: none;
        }

        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .theme-switcher .btn {
            background-color: var(--header-bg);
            color: var(--header-text);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }

        .theme-switcher .btn:hover {
            background-color: var(--hover-bg);
        }

        .theme-switcher .dropdown-menu {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-radius: 10px;
            padding: 0.5rem;
        }

        .theme-switcher .dropdown-item {
            color: var(--text-color);
            border-radius: 5px;
            padding: 0.5rem 1rem;
            transition: background-color 0.3s ease;
        }

        .theme-switcher .dropdown-item:hover {
            background-color: var(--table-row-hover);
        }

        .theme-switcher .dropdown-item.active {
            background-color: var(--header-bg);
            color: var(--header-text);
        }

        /* Select2 Theme Customization */
        .select2-container--default .select2-selection--single {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--text-color);
        }

        .select2-dropdown {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }

        .select2-container--default .select2-results__option {
            color: var(--text-color);
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--header-bg);
            color: var(--header-text);
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid var(--form-text);
        }
        
        .map-container {
            background: var(--map-heading-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .map-container h3 {
            color: var(--map-heading-text);
            margin-bottom: 15px;
        }
        
        .lead-marker {
            cursor: pointer;
        }
        
        .lead-info-window {
            max-width: 300px;
            background-color: var(--info-window-bg);
            color: var(--info-window-text);
            padding: 10px;
            border-radius: 8px;
        }
        
        .lead-info-window h5 {
            margin-bottom: 0.5rem;
            color: var(--info-window-text);
            font-weight: bold;
        }
        
        .lead-info-window p {
            margin-bottom: 0.25rem;
            color: var(--info-window-text);
        }

        .lead-info-window a {
            color: var(--info-window-link);
            text-decoration: none;
        }

        .lead-info-window a:hover {
            text-decoration: underline;
        }

        /* Update table styles for dark theme */
        .table {
            color: var(--text-color);
        }

        .table thead th {
            color: var(--table-header-text);
        }

        .table tbody td {
            color: var(--text-color);
        }

        /* Update form text colors */
        .form-label {
            color: var(--form-text);
        }

        .form-text {
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Update alert text color */
        .alert {
            color: var(--alert-text);
        }

        /* Update map container text */
        #mapContainer h3 {
            color: var(--map-heading-text);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--form-bg);
            border: 1px solid var(--form-text);
            color: var(--form-text);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--table-header-bg);
        }

        .theme-toggle i {
            font-size: 1.2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-form {
            background: var(--form-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-control {
            background-color: var(--form-bg);
            color: var(--form-text);
            border: 1px solid var(--form-text);
        }

        .form-control:focus {
            background-color: var(--form-bg);
            color: var(--form-text);
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background-color: #0b5ed7;
        }

        .results-section {
            margin-top: 30px;
        }

        .table {
            background-color: var(--table-bg);
            color: var(--table-text);
        }

        .table thead th {
            background-color: var(--table-header-bg);
            color: var(--table-text);
            border-bottom: 2px solid var(--table-text);
        }

        .table tbody tr {
            border-bottom: 1px solid var(--table-text);
        }

        .table tbody tr:hover {
            background-color: var(--table-header-bg);
        }

        .alert {
            background-color: var(--alert-bg);
            color: var(--alert-text);
            border: 1px solid var(--alert-text);
        }

        .gm-style-iw {
            background-color: var(--info-window-bg) !important;
            color: var(--info-window-text) !important;
            padding: 15px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }

        .gm-style-iw a {
            color: var(--info-window-link) !important;
            text-decoration: none !important;
        }

        .gm-style-iw a:hover {
            text-decoration: underline !important;
        }

        .gm-style-iw-d {
            overflow: hidden !important;
            max-height: none !important;
        }

        .gm-style-iw-c {
            padding: 0 !important;
            max-width: 300px !important;
        }

        .gm-style-iw-t::after {
            background: linear-gradient(45deg, var(--info-window-bg) 50%, transparent 50%) !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .search-form {
                padding: 15px;
            }
            
            .btn-primary {
                width: 100%;
                margin-top: 10px;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="bi bi-moon-fill" id="theme-icon"></i>
        <span id="theme-text">Dark Mode</span>
    </button>

    <div class="container">
        <h1 class="text-center mb-4">Business Lead Finder</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Search Parameters</h5>
                        <form id="searchForm">
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" placeholder="e.g., New York">
                            </div>
                            <div class="mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state" placeholder="e.g., NY">
                            </div>
                            <div class="mb-3">
                                <label for="businessType" class="form-label">Business Type</label>
                                <input type="text" class="form-control" id="businessType" name="businessType" required>
                            </div>
                            <div class="mb-3">
                                <label for="radius" class="form-label">Search Radius (miles)</label>
                                <input type="number" class="form-control" id="radius" name="radius" value="5" min="1" max="50" required>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="usePin" name="usePin">
                                    <label class="form-check-label" for="usePin">
                                        Also search around dropped pin
                                    </label>
                                </div>
                                <small class="form-text text-muted">Check this to include businesses around the dropped pin in your search results</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">Search</button>
                                <button type="button" class="btn btn-secondary" id="clearPin">Clear Pin</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div id="map" style="height: 400px;"></div>
            </div>
        </div>

        <div id="alert" class="alert alert-danger" style="display: none;"></div>

        <div class="map-container">
            <h3>Search Area</h3>
            <div id="map"></div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Search Results</h5>
                            <button id="exportBtn" class="btn btn-success" disabled onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="resultsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                        <th>Website</th>
                                        <th>Rating</th>
                                        <th>Opening Hours</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places"></script>
    <script>
        let map;
        let searchCircle;
        let markers = [];
        let droppedPin = null;
        let droppedPinMarker = null;
        
        // Theme handling
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (theme === 'dark') {
                themeIcon.className = 'bi bi-sun-fill';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.className = 'bi bi-moon-fill';
                themeText.textContent = 'Dark Mode';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        // Initialize theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // Initialize map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#7c93a3"},{"lightness": "-10"}]
                    },
                    {
                        "featureType": "administrative.country",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#7c93a3"}]
                    },
                    {
                        "featureType": "administrative.locality",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#7c93a3"}]
                    },
                    {
                        "featureType": "administrative.neighborhood",
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#7c93a3"}]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{"color": "#f2f2f2"}]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [{"saturation": "-100"},{"lightness": "45"}]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{"visibility": "simplified"}]
                    },
                    {
                        "featureType": "road.arterial",
                        "elementType": "labels.icon",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "all",
                        "stylers": [{"visibility": "off"}]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [{"color": "#46bcec"},{"visibility": "on"}]
                    }
                ]
            });

            // Add click listener for dropping pin
            map.addListener('click', function(e) {
                if (document.getElementById('usePin').checked) {
                    if (droppedPinMarker) {
                        droppedPinMarker.setMap(null);
                    }
                    droppedPin = e.latLng;
                    droppedPinMarker = new google.maps.Marker({
                        position: droppedPin,
                        map: map,
                        title: 'Dropped Pin',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#FF0000',
                            fillOpacity: 1,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2
                        }
                    });
                    map.panTo(droppedPin);
                }
            });
        }

        // Initialize map when the page loads
        window.onload = function() {
            console.log('Window loaded, initializing map...');  // Debug log
            initMap();
        };

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearResults();
            
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const businessType = document.getElementById('businessType').value;
            const radius = document.getElementById('radius').value;
            const usePin = document.getElementById('usePin').checked;
            
            try {
                let response;
                if (usePin && droppedPin) {
                    // If using both city and pin, make two separate requests
                    const cityResponse = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            city: city,
                            state: state,
                            business_type: businessType,
                            radius: radius
                        })
                    });
                    
                    const pinResponse = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            lat: droppedPin.lat(),
                            lng: droppedPin.lng(),
                            business_type: businessType,
                            radius: radius
                        })
                    });
                    
                    const cityData = await cityResponse.json();
                    const pinData = await pinResponse.json();
                    
                    if (cityData.error && pinData.error) {
                        showError('Both searches failed. Please try again.');
                        return;
                    }
                    
                    // Combine results, removing duplicates based on place_id
                    const allLeads = [...(cityData.leads || []), ...(pinData.leads || [])];
                    const uniqueLeads = Array.from(new Map(allLeads.map(lead => [lead.place_id, lead])).values());
                    
                    if (uniqueLeads.length > 0) {
                        displayResults(uniqueLeads);
                        // Use city center for map if available, otherwise use pin location
                        const center = cityData.center || pinData.center;
                        displayMap(uniqueLeads, center);
                        document.getElementById('exportBtn').disabled = false;
                    } else {
                        showError('No businesses found in the specified areas.');
                    }
                } else {
                    // Single search based on city
                    response = await fetch('/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            city: city,
                            state: state,
                            business_type: businessType,
                            radius: radius
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    if (data.leads && data.leads.length > 0) {
                        displayResults(data.leads);
                        displayMap(data.leads, data.center);
                        document.getElementById('exportBtn').disabled = false;
                    } else {
                        showError('No businesses found in the specified area.');
                    }
                }
            } catch (error) {
                showError('An error occurred while searching. Please try again.');
                console.error('Search error:', error);
            }
        });
        
        document.getElementById('clearPin').addEventListener('click', function() {
            if (droppedPinMarker) {
                droppedPinMarker.setMap(null);
                droppedPinMarker = null;
                droppedPin = null;
            }
        });

        function displayResults(leads) {
            const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
            resultsTable.innerHTML = '';
            
            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.address}</td>
                    <td>${lead.phone || 'N/A'}</td>
                    <td>${lead.website ? `<a href="${lead.website}" target="_blank">${lead.website}</a>` : 'N/A'}</td>
                    <td>${lead.rating || 'N/A'}</td>
                    <td>${lead.opening_hours ? lead.opening_hours.join('<br>') : 'N/A'}</td>
                `;
                resultsTable.appendChild(row);
            });
        }

        function displayMap(leads, center) {
            // Clear previous markers and circle
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            if (searchCircle) {
                searchCircle.setMap(null);
            }
            
            // Set map center and zoom
            map.setCenter(center);
            const radius = document.getElementById('radius').value * 1609.34; // Convert miles to meters
            const zoomLevel = Math.round(14 - Math.log2(radius / 1000));
            map.setZoom(zoomLevel);
            
            // Add search circle
            searchCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.1,
                map: map,
                center: center,
                radius: radius
            });
            
            // Add markers for each lead
            leads.forEach((lead, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: lead.lat, lng: lead.lng },
                    map: map,
                    title: lead.name,
                    animation: google.maps.Animation.DROP,
                    delay: index * 100
                });
                
                // Create info window content
                const content = `
                    <div style="color: var(--info-window-text);">
                        <h5>${lead.name}</h5>
                        <p>${lead.address}</p>
                        ${lead.phone ? `<p>Phone: ${lead.phone}</p>` : ''}
                        ${lead.website ? `<p>Website: <a href="${lead.website}" target="_blank">${lead.website}</a></p>` : ''}
                        ${lead.rating ? `<p>Rating: ${lead.rating} ‚≠ê</p>` : ''}
                        ${lead.opening_hours ? `<p>Hours:<br>${lead.opening_hours.join('<br>')}</p>` : ''}
                    </div>
                `;
                
                // Add click listener to marker
                marker.addListener('click', () => {
                    const infoWindow = new google.maps.InfoWindow({
                        content: content
                    });
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
            });
        }

        function showError(message) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
        }

        function clearResults() {
            const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
            resultsTable.innerHTML = '';
            document.getElementById('alert').style.display = 'none';
            document.getElementById('exportBtn').disabled = true;
        }

        async function exportToExcel() {
            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        leads: window.currentLeads || []
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `business_leads_${new Date().toISOString().slice(0,19).replace(/[:]/g, '')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const data = await response.json();
                    showError(data.error || 'Failed to export data');
                }
            } catch (error) {
                console.error('Export error:', error);
                showError('An error occurred while exporting the data');
            }
        }

        // Store current leads for export
        let currentLeads = [];
        function displayResults(leads) {
            currentLeads = leads;  // Store leads for export
            // ... rest of the displayResults function ...
        }
    </script>
</body>
</html> 